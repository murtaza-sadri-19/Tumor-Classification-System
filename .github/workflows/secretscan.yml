name: 'Prevent Secret Leaks on Push'

# This workflow runs on every push to every branch.
# If a secret is found, the job fails, and the push is rejected.
on: [push]

jobs:
  secret_scan:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the code
      # fetch-depth: 0 is CRITICAL as it fetches the *full* history, 
      # allowing gitleaks to scan past commits as well.
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history for comprehensive scanning

      # Step 2: Run Gitleaks Scan
      # We use the official Gitleaks action.
      - name: Run Gitleaks Scan
        # Use the official action (or similar community alternative)
        uses: gitleaks/gitleaks-action@v2
        
        # Pass a GitHub Token for the action to use (e.g., to comment on PRs if needed)
        # Note: A GITLEAKS_LICENSE is required for ORGANIZATIONS (free for personal accounts)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Uncomment if in an organization
        
        # Configure the scan to focus only on new changes to speed up the process.
        # This prevents scanning the entire history *every* time, 
        # but the `fetch-depth: 0` ensures the history is available if needed.
        with:
          # Use a baseline commit to compare against (usually the main branch)
          # This speeds up the scan by only checking the difference between the 
          # push and the target branch.
          base_ref: ${{ github.event.before }}
          head_ref: ${{ github.sha }}
